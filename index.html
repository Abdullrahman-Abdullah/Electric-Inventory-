<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أبو الياس للكهرباء</title>
<link rel="manifest" href="./manifest.json">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        /* =================================== */
        /* التنسيقات العامة والمتغيرات */
        /* =================================== */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --sell-color: #9b59b6;
            --invoice-color: #e67e22;
            --light-bg: #f8f9fa;
            --light-text: #2c3e50;
            --light-card: #ffffff;
            --light-border: #e0e0e0;
            --dark-bg: #1a1a2e;
            --dark-text: #e6e6e6;
            --dark-card: #16213e;
            --dark-border: #2d4059;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --low-stock-color: #f39c12;
            --very-low-stock-color: #e74c3c;
            --normal-stock-color: #27ae60;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: var(--transition);
            line-height: 1.6;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light-border);
        }

        body.dark-mode header {
            border-bottom-color: var(--dark-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 26px;
            color: var(--primary-color);
            font-weight: 700;
        }

        .logo-icon {
            font-size: 32px;
            color: var(--primary-color);
        }
        
        /* =================================== */
        /* تنسيقات التحكم والبحث والفلترة */
        /* =================================== */
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle, .stats-btn, .settings-btn, .invoice-btn, .categories-btn {
            background: var(--light-card);
            border: 1px solid var(--light-border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--light-text);
        }
        
        .invoice-btn {
            background-color: var(--invoice-color);
            color: white;
        }
        
        .categories-btn {
            background-color: var(--info-color);
            color: white;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-and-filter-area {
            display: flex;
            gap: 15px;
            flex-grow: 1;
            flex-wrap: wrap;
            min-width: 50%;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 15px 100px 15px 20px;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--light-card);
        }
        
        .search-box button.barcode-btn { 
            position: absolute;
            right: 50px; 
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--sell-color);
            transition: var(--transition);
        }

        .search-box button.search-icon-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--primary-color);
        }
        
        /* فلترة وفرز - تم تبسيط تنسيق القوائم المنسدلة */
        .filter-group, .sort-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }
        
        .filter-group label, .sort-group label {
            font-size: 12px;
            color: #777;
            font-weight: 600;
        }
        
        .filter-group select, .sort-group select {
            padding: 12px;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            background-color: var(--light-card);
            font-size: 14px;
            transition: var(--transition);
            /* إزالة التنسيقات المخصصة للسهم التي كانت تسبب مشاكل */
        }
        
        .attention-filter-btn {
            background-color: var(--warning-color);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 45px;
            margin-top: 17px;
        }
        
        .attention-filter-btn.active {
            background-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.4);
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .add-btn, .show-more-btn, .create-invoice-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .show-more-btn { 
            background: var(--success-color);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .create-invoice-btn {
            background: var(--invoice-color);
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3);
        }

        /* =================================== */
        /* تنسيقات كروت المنتجات */
        /* =================================== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .product-card {
            background-color: var(--light-card);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--light-border);
            display: flex;
            flex-direction: column;
        }
        
        .product-card.low-stock-alert {
            border-right: 5px solid var(--low-stock-color);
        }
        
        .product-card.very-low-stock-alert {
            border-right: 5px solid var(--very-low-stock-color);
            animation: pulse-danger 1.5s infinite alternate;
        }
        
        /* تنسيق الفئات - تعديل لتحسين المظهر */
        .product-header {
            padding: 15px 20px 10px;
            border-bottom: 1px solid var(--light-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .product-id {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 18px;
            flex-basis: 100%;
        }
        
        .product-category {
            /* التعديل الجديد للفئة */
            font-size: 11px;
            font-weight: 700;
            color: var(--dark-text); /* لون النص سيكون داكن بالوضع الفاتح */
            background: linear-gradient(45deg, var(--info-color), #20b8d0); /* لون متدرج */
            padding: 4px 10px;
            border-radius: 15px; /* شكل بيضاوي */
            box-shadow: 0 2px 5px rgba(23, 162, 184, 0.3);
            text-transform: uppercase;
        }
        
        body.dark-mode .product-category {
            color: var(--light-card); /* لون النص سيكون فاتح بالوضع الداكن */
        }
        /* نهاية تعديل الفئات */
        
        /* تنسيقات أزرار حركات المنتج (Fix) */
        .product-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
            padding: 15px; 
            border-top: 1px solid var(--light-border);
        }

        .product-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
        }
        
        .product-actions .sell-btn {
            background-color: var(--sell-color);
            color: white;
            padding: 8px 12px;
        }
        .product-actions .sell-btn:hover {
            background-color: #8e44ad;
        }
        .product-actions .add-quantity-btn {
            background-color: var(--success-color);
            color: white;
            padding: 8px; 
            width: 38px;
            height: 38px;
            justify-content: center;
        }
        .product-actions .add-quantity-btn:hover {
            background-color: #2ecc71;
        }
        .product-actions .edit-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 8px;
             width: 38px;
            height: 38px;
            justify-content: center;
        }
        .product-actions .edit-btn:hover {
            background-color: var(--secondary-color);
        }
        .product-actions .delete-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 8px;
             width: 38px;
            height: 38px;
            justify-content: center;
        }
        .product-actions .delete-btn:hover {
            background-color: #c0392b;
        }
        .product-actions button i {
            font-size: 16px;
        }
        
        .product-actions .add-to-invoice-btn {
            background-color: var(--invoice-color);
            color: white;
            padding: 8px 12px;
        }
        .product-actions .add-to-invoice-btn:hover {
            background-color: #d35400;
        }
        
        .product-body {
            padding: 20px;
            flex-grow: 1;
        }
        
        /* تمييز وصف المنتج - التعديل المطلوب */
        .product-description {
            margin-bottom: 15px;
            font-size: 16px;
            line-height: 1.5;
            color: var(--light-text);
            /* التمييز */
            padding: 10px;
            border-right: 4px solid var(--warning-color);
            background-color: rgba(243, 156, 18, 0.05); 
            border-radius: 4px;
            font-weight: 500;
            margin-bottom: 20px;
            /* نهاية التمييز */
        }

        body.dark-mode .product-description {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--dark-text);
        }
        
        .reorder-point-display {
            font-size: 12px;
            color: var(--low-stock-color);
            margin-top: 5px;
            font-weight: 600;
        }

        /* تنسيقات عرض الأسعار والأرباح */
        .product-prices {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--light-border);
        }
        
        .product-prices .price-item {
            flex-basis: 48%;
            text-align: center;
        }
        
        .price-label {
            font-size: 12px;
            color: #777;
            font-weight: 600;
        }
        
        .price-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .purchase-price {
            color: var(--danger-color);
        }
        
        .sale-price {
            color: var(--success-color);
        }

        .product-profit {
            font-size: 14px;
            font-weight: 700;
            color: var(--sell-color);
            text-align: center;
            margin-bottom: 5px;
        }
        
        .product-profit + .currency-note {
            text-align: center;
            font-size: 12px;
            color: #777;
            margin-bottom: 15px;
        }
        
        /* تحسين تنسيق التواريخ - التعديل المطلوب */
        .product-dates {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
            padding-top: 10px;
            border-top: 1px dashed var(--light-border);
            margin-top: 10px;
        }
        /* نهاية تحسين تنسيق التواريخ */
        
        
        /* =================================== */
        /* تنسيقات الـ Toast Notifications */
        /* =================================== */
        #toastContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(-20px);
            min-width: 300px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.error {
            background-color: var(--danger-color);
        }
        
        .toast.warning {
            background-color: var(--warning-color);
        }

        /* =================================== */
        /* تنسيقات Dark Mode والمدخلات */
        /* =================================== */
        body.dark-mode .theme-toggle, 
        body.dark-mode .stats-btn, 
        body.dark-mode .settings-btn,
        body.dark-mode .invoice-btn,
        body.dark-mode .categories-btn {
            background: var(--dark-card);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }
        
        body.dark-mode .search-box input,
        body.dark-mode .filter-group select, 
        body.dark-mode .sort-group select {
            background-color: var(--dark-card);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }
        
        body.dark-mode .product-card {
            background-color: var(--dark-card);
            border-color: var(--dark-border);
        }
        
        body.dark-mode .product-quantity {
            background-color: #00000000;
            border-color: var(--dark-border);
        }
        
        /* استكمال باقي التنسيقات... */
        
        .form-row-triple {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-triple .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light-border);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--light-bg);
            transition: var(--transition);
        }
        
        /* =================================== */
        /* تنسيقات الـ Modals الأساسية */
        /* =================================== */
       .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--light-card);
            width: 90%;
            max-width: 600px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            transition: var(--transition);
            max-height: 80svh;
            overflow-y: auto;
            z-index:1000;
            
        }
        
        body.dark-mode .modal-content {
            background-color: var(--dark-card);
        }
        
        @keyframes slide-down {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light-border);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        /* تنسيق زر الإغلاق - التعديل المطلوب */
        .close-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.4);
        }

        .close-btn:hover, .close-btn:focus {
            background-color: #c0392b;
            transform: rotate(90deg);
        }
        /* نهاية تعديل زر الإغلاق */

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input[type="text"], 
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light-border);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--light-bg);
            transition: all 0.3s;
        }
        
        body.dark-mode .form-group input[type="text"],
        body.dark-mode .form-group input[type="number"],
        body.dark-mode .form-group textarea,
        body.dark-mode .form-group select {
            background-color: var(--dark-bg);
            border-color: var(--dark-border);
            color: var(--dark-text);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        .cancel-btn, .save-btn, .sell-action-btn, .invoice-action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .cancel-btn {
            background-color: #bdc3c7;
            color: var(--light-text);
        }

        .save-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .sell-action-btn {
            background-color: var(--sell-color);
            color: white;
        }
        
        .invoice-action-btn {
            background-color: var(--invoice-color);
            color: white;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row > .form-group {
            flex: 1;
        }
        
        /* =================================== */
        /* تنسيقات الإحصائيات (Stats Modal - FIX) */
        /* =================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--light-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary-color);
            transition: var(--transition);
            cursor: pointer;
        }

        body.dark-mode .stat-card {
            background-color: var(--dark-bg);
            border-color: var(--dark-border);
        }

        .stat-card i {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-card h3 {
            font-size: 16px;
            color: #777;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--light-text);
        }

        body.dark-mode .stat-card .value {
            color: var(--dark-text);
        }

        .stat-card.total-profit {
            border-left-color: var(--sell-color);
        }
        .stat-card.total-profit i {
            color: var(--sell-color);
        }

        .stat-card.low-stock {
            border-left-color: var(--danger-color);
        }
        .stat-card.low-stock i {
            color: var(--danger-color);
        }
        
        /* تنسيق قسم الإحصائيات الذي كان موجوداً سابقاً */
        .stat-card.transactions-count {
            border-left: 5px solid var(--info-color);
        }
        
        .stat-card.transactions-count i {
            color: var(--info-color);
        }
        
        #lowStockUl {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--light-border);
            padding: 10px;
            border-radius: var(--border-radius);
        }
        
        #lowStockUl li {
            padding: 8px 0;
            border-bottom: 1px dotted var(--light-border);
            display: flex;
            justify-content: space-between;
        }
        
        /* =================================== */
        /* تنسيقات الإعدادات (Settings Modal - FIX) */
        /* =================================== */
        
        .settings-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .settings-btn-action {
            /* التنسيق الجديد لأزرار الإعدادات */
            background: var(--light-card);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .settings-btn-action:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .settings-btn-action i {
            font-size: 18px;
        }

        /* تعديل ألوان الاستيراد والتصدير */
        .export-btn {
            border-color: var(--success-color);
            color: var(--success-color);
        }
        .export-btn:hover {
            background: var(--success-color);
            color: white;
        }

        .import-btn {
            border-color: var(--info-color);
            color: var(--info-color);
        }
        .import-btn:hover {
            background: var(--info-color);
            color: white;
        }
        
        /* نهاية تعديل ألوان الاستيراد والتصدير */

        .delete-data-btn {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        .delete-data-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .info-btn {
            border-color: var(--warning-color);
            color: var(--warning-color);
        }
        .info-btn:hover {
            background: var(--warning-color);
            color: white;
        }
        
        /* =================================== */
        /* تنسيقات نظام الفوترة */
        /* =================================== */
        .invoice-items-container {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--light-border);
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item-details {
            flex: 1;
        }

        .invoice-item-id {
            font-weight: bold;
            color: var(--primary-color);
        }

        .invoice-item-description {
            font-size: 14px;
            color: #777;
        }

        .invoice-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-control button {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .quantity-control button:hover {
            background: var(--secondary-color);
        }

        .quantity-control input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--light-border);
            border-radius: 4px;
            padding: 5px;
        }

        .invoice-item-price {
            font-weight: bold;
            color: var(--success-color);
            min-width: 80px;
            text-align: right;
        }

        .invoice-item-remove {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .invoice-item-remove:hover {
            background: #c0392b;
            
        }

        .invoice-summary {
            /*background: var(--light-bg);*/
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            
        }

        .invoice-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .invoice-summary-total {
            font-weight: bold;
            font-size: 18px;
            border-top: 1px solid var(--light-border);
            padding-top: 10px;
            margin-top: 10px;
        }

        .invoice-history-item {
            padding: 15px;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .invoice-history-item:hover {
            background: var(--light-bg);
        }

        body.dark-mode .invoice-history-item:hover {
            background: var(--dark-bg);
        }

        .invoice-history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .invoice-history-id {
            font-weight: bold;
            color: var(--primary-color);
        }

        .invoice-history-date {
            color: #777;
            font-size: 14px;
        }

        .invoice-history-customer {
            margin-bottom: 10px;
        }

        .invoice-history-total {
            font-weight: bold;
            color: var(--success-color);
        }
        
        /* =================================== */
        /* تنسيقات إدارة الفئات */
        /* =================================== */
        .categories-list {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--light-border);
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-name {
            font-weight: bold;
            color: var(--info-color);
        }

        .category-count {
            color: #777;
            font-size: 14px;
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .category-delete-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .category-delete-btn:hover {
            background: #c0392b;
        }
        
        /* =================================== */
        /* تنسيقات عرض الفواتير المحفوظة */
        /* =================================== */
        .invoices-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .invoice-item-detailed {
            padding: 15px;
            border: 1px solid var(--light-border);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            transition: var(--transition);
        }

        .invoice-item-detailed:hover {
            background: var(--light-bg);
        }

        body.dark-mode .invoice-item-detailed:hover {
            background: var(--dark-bg);
        }

        .invoice-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .invoice-item-id {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 18px;
        }

        .invoice-item-date {
            color: #777;
            font-size: 14px;
        }

        .invoice-item-customer {
            margin-bottom: 10px;
            font-weight: 600;
        }

        .invoice-item-products {
            margin-bottom: 10px;
        }

        .invoice-product-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted var(--light-border);
        }

        .invoice-product-item:last-child {
            border-bottom: none;
        }

        .invoice-item-total {
            font-weight: bold;
            color: var(--success-color);
            font-size: 16px;
            text-align: right;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--light-border);
        }

        .invoice-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .invoice-delete-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .invoice-delete-btn:hover {
            background: #c0392b;
        }

        .invoice-print-btn {
            background: var(--info-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .invoice-print-btn:hover {
            background: #2980b9;
        }
        
        /* =================================== */
        /* تنسيقات ماسح الباركود */
        /* =================================== */
        #interactive.viewport {
            width: 100%;
            max-width: 400px;
            height: 300px;
            margin: 20px auto;
            border: 3px solid var(--primary-color);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            text-align: left;
        }

        #interactive.viewport canvas, 
        #interactive.viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .barcode-scanner-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .barcode-scanner-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        #startScanner {
            background-color: var(--success-color);
            color: white;
        }

        #stopScanner {
            background-color: var(--danger-color);
            color: white;
        }

        .barcode-result {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            text-align: center;
        }

        body.dark-mode .barcode-result {
            background-color: var(--dark-bg);
        }

        /* =================================== */
        /* الـ Media Queries */
        /* =================================== */
        
        @media (max-width: 1000px) {
            .search-and-filter-area {
                flex-basis: 100%;
                justify-content: space-between;
            }
            .search-box {
                flex-basis: 100%;
                margin-bottom: 10px;
            }
            .filter-group, .sort-group {
                min-width: 30%;
                flex-grow: 1;
            }
            .attention-filter-btn {
                margin-top: 0;
                height: auto;
                padding: 10px 15px;
                flex-grow: 1;
            }
        }
        
        @media (max-width: 768px) {
            .form-row-triple {
                flex-direction: column;
                gap: 0;
            }
            .stats-grid {
                 grid-template-columns: 1fr;
            }
            .product-dates {
                flex-direction: column;
                gap: 5px;
            }
            .invoice-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .invoice-item-controls {
                width: 100%;
                justify-content: space-between;
            }
            .invoice-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
    </style>
</head>
<body>
    <div id="toastContainer"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">⚡</div>
                <!--<h1>أبو الياس للكهرباء - إدارة المخزون</h1>-->
            </div>
            <div class="header-controls">
                
                <button class="invoice-btn" id="invoiceBtn" title="نظام الفوترة">
                    <i class="fas fa-file-invoice-dollar"></i>
                </button>
                
                <button class="stats-btn" id="statsBtn" title="الإحصائيات">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="settings-btn" id="settingsBtn" title="الإعدادات">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <div class="controls">
            <div class="search-and-filter-area">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ابحث عن قطعة بالاسم أو المعرف...">
                    <button type="button" id="scanBarcodeBtn" class="barcode-btn" title="مسح باركود">
                        <i class="fas fa-qrcode"></i>
                    </button>
                    <button type="button" class="search-icon-btn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="filter-group">
                    <label for="categoryFilter">فلترة حسب الفئة</label>
                    <select id="categoryFilter">
                        <option value="all">جميع الفئات</option>
                        </select>
                </div>
                
                <div class="sort-group">
                    <label for="sortSelector">ترتيب حسب</label>
                    <select id="sortSelector">
                        <option value="updatedAt_desc">آخر تحديث (الأحدث)</option>
                        <option value="quantity_asc">الكمية (الأقل أولاً)</option>
                        <option value="quantity_desc">الكمية (الأكثر أولاً)</option>
                        <option value="profit_asc">الربح (الأقل أولاً)</option>
                        <option value="profit_desc">الربح (الأكثر أولاً)</option>
                        <option value="id_asc">المعرف (أبجدياً)</option>
                    </select>
                </div>
                
                <button class="attention-filter-btn" id="attentionFilterBtn" title="عرض المنتجات التي تحتاج انتباهاً فقط">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>عرض الانتباه</span>
                </button>
            </div>
            
            <div class="control-buttons">
                <button class="create-invoice-btn" id="createInvoiceBtn">
                    <i class="fas fa-file-invoice"></i>
                    <span>فاتورة جديدة</span>
                </button>
                <button class="add-btn" id="addProductBtn">
                    <i class="fas fa-plus"></i>
                    <span>إضافة منتج</span>
                </button>
                <button class="show-more-btn" id="showMoreBtn" style="display: none;">
                    <i class="fas fa-chevron-down"></i>
                    <span>عرض المزيد</span>
                </button>
            </div>
        </div>

        <div class="products-grid" id="productsGrid">
        </div>
        
        <div class="loading-indicator" id="loadingIndicator">
             <i class="fas fa-spinner fa-spin"></i> جار تحميل المنتجات...
        </div>
    </div>

    <!-- Modal إضافة/تعديل منتج -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">إضافة منتج جديد</h2>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <form id="productForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productId">معرف المنتج *</label>
                        <input type="text" id="productId" required>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">الفئة/التصنيف *</label>
                        <select id="productCategory" required>
                            <option value="اخرى">اخرى</option>
                            <!-- سيتم ملؤها ديناميكياً -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productDescription">وصف المنتج *</label>
                    <textarea id="productDescription" required></textarea>
                </div>
                <div class="form-row-triple">
                    <div class="form-group">
                        <label for="purchasePrice">سعر الشراء ($) *</label>
                        <input type="number" id="purchasePrice" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="salePrice">سعر المبيع ($) *</label>
                        <input type="number" id="salePrice" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">الكمية في المخزون *</label>
                        <input type="number" id="productQuantity" min="0" step="1" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reorderPoint">نقطة إعادة الطلب (حد التنبيه)</label>
                        <input type="number" id="reorderPoint" min="1" step="1" value="5" required>
                        <div class="currency-note">سيظهر التنبيه الأصفر إذا كانت الكمية أقل أو تساوي هذا الرقم.</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelBtn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i>
                        حفظ المنتج
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal إضافة كمية -->
    <div class="modal" id="addQuantityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="addQuantityTitle">إضافة كمية إلى:</h2>
                <button class="close-btn" id="closeAddQuantityModal">&times;</button>
            </div>
            <form id="addQuantityForm">
                <div class="form-group">
                    <label for="quantityToAdd">الكمية المراد إضافتها</label>
                    <input type="number" id="quantityToAdd" min="1" step="1" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelAddQuantityBtn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button type="submit" class="save-btn">
                        <i class="fas fa-plus"></i>
                        إضافة الكمية
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal بيع -->
    <div class="modal" id="sellModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="sellModalTitle">بيع قطع من:</h2>
                <button class="close-btn" id="closeSellModal">&times;</button>
            </div>
            <form id="sellForm">
                <div class="form-group">
                    <label for="quantityToSell">عدد القطع المباعة</label>
                    <input type="number" id="quantityToSell" min="1" step="1" required>
                    <div class="currency-note">الكمية المتاحة حالياً: <span id="currentStockDisplay">0</span></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" id="cancelSellBtn">
                        <i class="fas fa-times"></i>
                        إلغاء
                    </button>
                    <button type="submit" class="sell-action-btn">
                        <i class="fas fa-hand-holding-usd"></i>
                        خصم وبيع
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal الإحصائيات -->
    <div class="modal" id="statsModal">
        <div class="modal-content" style="max-width: 750px;">
            <div class="modal-header">
                <h2>إحصائيات المخزون</h2>
                <button class="close-btn" id="closeStatsModal">&times;</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card total-products">
                    <i class="fas fa-boxes"></i>
                    <h3>إجمالي المنتجات (صنف)</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card total-profit">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>إجمالي الأرباح المتوقعة</h3>
                    <div class="value" id="totalProfit">0 $</div>
                    <div class="currency-note" id="totalProfitLira">0 ل.س</div>
                </div>
                <div class="stat-card low-stock" id="lowStockCard">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>منتجات تحتاج انتباهاً</h3>
                    <div class="value" id="lowStockCount">0</div>
                    <div class="currency-note">(مخزون قليل أو ربح $\lt 2\$)$</div>
                </div>
                <div class="stat-card transactions-count">
                    <i class="fas fa-exchange-alt"></i>
                    <h3>سجل المبيع | شراء</h3>
                    <div class="value" id="totalTransactions">0</div>
                    <div class="currency-note">(بيع + إضافة كمية)</div>
                </div>
            </div>
            <div id="lowStockList" style="display: none;">
                <h3>قائمة المنتجات التي تحتاج انتباهاً:</h3>
                <ul id="lowStockUl"></ul>
            </div>
        </div>
    </div>

    <!-- Modal الإعدادات -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>الإعدادات</h2>
                <button class="close-btn" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-header">
              <button class="theme-toggle" id="themeToggle" title="تبديل الوضع">
                    <i class="fas fa-moon"></i>
                </button>
              <button class="categories-btn" id="categoriesBtn" title="إدارة الفئات">
                    <i class="fas fa-tags"></i>
                </button>
                <button class="categories-btn">
                  <a href="barcodecreator.html" style="color: white; text-decoration:none;">QR</a>
                </button>
            </div>
            <div class="form-group">
                <label for="exchangeRateInput">سعر صرف الدولار مقابل الليرة السورية</label>
                <input type="number" id="exchangeRateInput" min="1" step="0.01" placeholder="أدخل سعر الصرف الحالي">
                
            </div>
            <div class="exchange-rate">
                <p>القيمة الحالية لسعر الصرف: <span id="currentExchangeRate">غير محدد</span></p>
            
            </div>
            <div class="settings-actions">
                <button class="settings-btn-action export-btn" id="exportDataBtn">
                    <i class="fas fa-file-export"></i>
                    تصدير البيانات إلى JSON
                </button>
                <button class="settings-btn-action import-btn" id="importDataBtn">
                    <i class="fas fa-file-import"></i>
                    استيراد البيانات من JSON
                </button>
                <button class="settings-btn-action info-btn" id="viewTransactionsBtn">
                    <i class="fas fa-history"></i>
                    سجل المبيع | شراء  
                </button>
                <button class="settings-btn-action info-btn" id="viewInvoicesBtn">
                    <i class="fas fa-file-invoice"></i>
                    عرض الفواتير المحفوظة
                </button>
                <button class="settings-btn-action delete-data-btn" id="deleteDataBtn">
                    <i class="fas fa-trash-alt"></i>
                    حذف جميع البيانات
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal مسح الباركود الجديد -->
    <div class="modal" id="barcodeScanModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ماسح الباركود</h2>
                <button class="close-btn" id="closeBarcodeModal">&times;</button>
            </div>
            
            <div id="interactive" class="viewport"></div>
            
            <div class="barcode-scanner-controls">
                <button id="startScanner">بدء المسح</button>
                <button id="stopScanner">إيقاف المسح</button>
            </div>
            
            <div class="barcode-result" id="barcodeResult">
                <p>سيظهر رمز الباركود هنا عند مسحه</p>
            </div>
            
            <div class="form-actions">
                <button type="button" class="cancel-btn" id="closeBarcodeBtn">
                    <i class="fas fa-times"></i>
                    إغلاق
                </button>
                <button type="button" class="save-btn" id="useBarcodeBtn">
                    <i class="fas fa-check"></i>
                    استخدام الباركود
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal سجل التحركات -->
    <div class="modal" id="transactionsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>سجل المبيع | شراء</h2>
                <button class="close-btn" id="closeTransactionsModal">&times;</button>
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px; text-align: center;">
                <thead>
                    <tr style="background-color: #00000000;">
                        <th style="padding: 10px; border-bottom: 1px solid var(--light-border);">المعرف</th>
                        <th style="padding: 10px; border-bottom: 1px solid var(--light-border);">النوع</th>
                        <th style="padding: 10px; border-bottom: 1px solid var(--light-border);">التغيير</th>
                        <th style="padding: 10px; border-bottom: 1px solid var(--light-border);">التاريخ</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody">
                </tbody>
            </table>
            <div style="text-align: center; margin-top: 20px;">
                 <button class="settings-btn-action delete-data-btn" id="clearTransactionsBtn">
                    <i class="fas fa-trash-alt"></i>
                    حذف سجل بيع | شراء
                </button>
            </div>
        </div>
    </div>

    <!-- Modal إدارة الفئات -->
    <div class="modal" id="categoriesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إدارة الفئات</h2>
                <button class="close-btn" id="closeCategoriesModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="newCategoryName">اسم الفئة الجديدة</label>
                <input type="text" id="newCategoryName" placeholder="أدخل اسم الفئة الجديدة">
            </div>
            <div class="form-actions">
                <button type="button" class="cancel-btn" id="cancelCategoryForm">إلغاء</button>
                <button type="button" class="save-btn" id="addCategoryBtn">إضافة الفئة</button>
            </div>
            <div class="categories-list" id="categoriesList">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
        </div>
    </div>

    <!-- Modal نظام الفوترة -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>نظام الفوترة</h2>
                <button class="close-btn" id="closeInvoiceModal">&times;</button>
            </div>
            <div class="form-group">
                <label for="customerName">اسم العميل</label>
                <input type="text" id="customerName" placeholder="أدخل اسم العميل">
            </div>
            <div class="form-group">
                <label for="customerAddress">عنوان العميل</label>
                <input type="text" id="customerAddress" placeholder="أدخل عنوان العميل">
            </div>
            
            <div class="invoice-items-container" id="invoiceItemsContainer">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
            
            <div class="invoice-summary">
                <div class="invoice-summary-row">
                    <span>عدد المنتجات:</span>
                    <span id="invoiceItemsCount">0</span>
                </div>
                <div class="invoice-summary-row">
                    <span>المجموع الفرعي:</span>
                    <span id="invoiceSubtotal">0.00 $</span>
                </div>
                <div class="invoice-summary-row">
                    <span>المجموع بالليرة:</span>
                    <span id="invoiceSubtotalLira">0 ل.س</span>
                </div>
                <div class="invoice-summary-row invoice-summary-total">
                    <span>المجموع الكلي:</span>
                    <span id="invoiceTotal">0.00 $</span>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="cancel-btn" id="cancelInvoice">إلغاء</button>
                <button type="button" class="invoice-action-btn" id="saveInvoiceBtn">حفظ الفاتورة</button>
            </div>
        </div>
    </div>

    <!-- Modal عرض الفواتير المحفوظة -->
    <div class="modal" id="invoicesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>الفواتير المحفوظة</h2>
                <button class="close-btn" id="closeInvoicesModal">&times;</button>
            </div>
            <div class="invoices-list" id="invoicesList">
                <!-- سيتم ملؤها ديناميكياً -->
            </div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display: none;">

    <script>
        // ===================================
        // البيانات والمتغيرات الأساسية
        // ===================================
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let categories = JSON.parse(localStorage.getItem('categories')) || ['كابلات', 'قواطع', 'مقابس', 'إضاءة', 'لوحات', 'اخرى'];
        let exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 5000;
        let darkMode = localStorage.getItem('darkMode') === 'true';

        // المتغيرات الخاصة بالتحكم في العرض
        const productsPerPage = 5; 
        let currentPage = 1;
        let isSearching = false;
        let isAttentionFiltered = false;

        // المتغيرات المساعدة
        let isEditMode = false;
        let currentEditId = null;
        let currentQuantityProductId = null;
        let currentSellProductId = null;
        let currentInvoice = JSON.parse(localStorage.getItem('currentInvoice')) || { items: [], customerName: '', customerAddress: '' };
        const LOW_PROFIT_THRESHOLD = 2.0;
        let currentScanner = null;
        let scannedBarcode = '';

        // ===================================
        // عناصر DOM
        // ===================================
        const themeToggle = document.getElementById('themeToggle');
        const statsBtn = document.getElementById('statsBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const categoriesBtn = document.getElementById('categoriesBtn');
        const invoiceBtn = document.getElementById('invoiceBtn');
        const searchInput = document.getElementById('searchInput');
        const addProductBtn = document.getElementById('addProductBtn');
        const createInvoiceBtn = document.getElementById('createInvoiceBtn');
        const productsGrid = document.getElementById('productsGrid');
        const showMoreBtn = document.getElementById('showMoreBtn'); 
        const loadingIndicator = document.getElementById('loadingIndicator'); 
        const categoryFilter = document.getElementById('categoryFilter'); 
        const sortSelector = document.getElementById('sortSelector'); 
        const attentionFilterBtn = document.getElementById('attentionFilterBtn'); 
        const toastContainer = document.getElementById('toastContainer');
        const viewInvoicesBtn = document.getElementById('viewInvoicesBtn');

        // حقول نموذج المنتج
        const productModal = document.getElementById('productModal');
        const modalTitle = document.getElementById('modalTitle');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productDescriptionInput = document.getElementById('productDescription');
        const productCategoryInput = document.getElementById('productCategory');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const salePriceInput = document.getElementById('salePrice');
        const productQuantityInput = document.getElementById('productQuantity'); 
        const reorderPointInput = document.getElementById('reorderPoint'); 

        // نموذج سجل التحركات 
        const transactionsModal = document.getElementById('transactionsModal');
        const transactionsTableBody = document.getElementById('transactionsTableBody');
        const viewTransactionsBtn = document.getElementById('viewTransactionsBtn');
        const closeTransactionsModal = document.getElementById('closeTransactionsModal');
        const clearTransactionsBtn = document.getElementById('clearTransactionsBtn');

        // ===================================
        // وظائف الحفظ والتخزين
        // ===================================
        
        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }
        
        function saveTransactions() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        function saveInvoices() {
            localStorage.setItem('invoices', JSON.stringify(invoices));
        }

        function saveCurrentInvoice() {
            localStorage.setItem('currentInvoice', JSON.stringify(currentInvoice));
        }

        function recordTransaction(productId, type, quantityChange) {
            const now = new Date().toISOString();
            transactions.unshift({
                id: Date.now(),
                productId,
                type,
                quantityChange,
                timestamp: now
            });
            saveTransactions();
        }

        // ===================================
        // وظائف الواجهة والـ UX
        // ===================================
        
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            
            if (type === 'success') {
                toast.querySelector('i').className = 'fas fa-check-circle';
            } else if (type === 'error') {
                 toast.querySelector('i').className = 'fas fa-times-circle';
            } else if (type === 'warning') {
                 toast.querySelector('i').className = 'fas fa-exclamation-triangle';
            }

            toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'غير متوفر';
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-SY', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).replace('،', ' ');
        }
        
        function updateTheme() {
            if (darkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        function toggleTheme() {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            updateTheme();
        }

        // ===================================
        // إدارة الفئات
        // ===================================
        
        function updateCategoriesDropdown() {
            // تحديث قائمة الفئات في الفلتر
            categoryFilter.innerHTML = '<option value="all">جميع الفئات</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            // تحديث قائمة الفئات في نموذج المنتج
            productCategoryInput.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                productCategoryInput.appendChild(option);
            });
        }

        function renderCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            if (categories.length === 0) {
                categoriesList.innerHTML = '<p style="text-align: center; color: #777;">لا توجد فئات</p>';
                return;
            }
            
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                
                const categoryCount = products.filter(p => p.category === category).length;
                
                categoryItem.innerHTML = `
                    <div>
                        <span class="category-name">${category}</span>
                        <div class="category-count">${categoryCount} منتج</div>
                    </div>
                    <div class="category-actions">
                        <button class="category-delete-btn" data-category="${category}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                categoriesList.appendChild(categoryItem);
            });
            
            // إضافة أحداث لحذف الفئات
            document.querySelectorAll('.category-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    deleteCategory(category);
                });
            });
        }

        function addCategory() {
            const newCategoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!newCategoryName) {
                showToast('يرجى إدخال اسم الفئة', 'error');
                return;
            }
            
            if (categories.includes(newCategoryName)) {
                showToast('هذه الفئة موجودة بالفعل', 'error');
                return;
            }
            
            categories.push(newCategoryName);
            saveCategories();
            updateCategoriesDropdown();
            renderCategoriesList();
            document.getElementById('newCategoryName').value = '';
            showToast('تمت إضافة الفئة بنجاح');
        }

        function deleteCategory(category) {
            // التحقق مما إذا كانت الفئة مستخدمة في أي منتج
            const productsInCategory = products.filter(p => p.category === category);
            
            if (productsInCategory.length > 0) {
                showToast(`لا يمكن حذف الفئة "${category}" لأنها مستخدمة في ${productsInCategory.length} منتج`, 'error');
                return;
            }
            
            if (confirm(`هل أنت متأكد من حذف الفئة "${category}"؟`)) {
                categories = categories.filter(c => c !== category);
                saveCategories();
                updateCategoriesDropdown();
                renderCategoriesList();
                showToast('تم حذف الفئة بنجاح');
            }
        }

        function showCategoriesModal() {
            renderCategoriesList();
            document.getElementById('categoriesModal').style.display = 'flex';
        }

        function closeCategoriesModal() {
            document.getElementById('categoriesModal').style.display = 'none';
        }

        // ===================================
        // نظام الفوترة وعرض الفواتير المحفوظة
        // ===================================
        
        function showInvoiceModal() {
            document.getElementById('invoiceModal').style.display = 'flex';
            renderInvoiceItems();
            updateInvoiceSummary();
            
            // تحميل اسم العميل وعنوانه من الفاتورة الحالية
            document.getElementById('customerName').value = currentInvoice.customerName || '';
            document.getElementById('customerAddress').value = currentInvoice.customerAddress || '';
        }

        function closeInvoiceModal() {
            // التعديل: حفظ الفاتورة الحالية بدلاً من حذفها
            saveCurrentInvoice();
            document.getElementById('invoiceModal').style.display = 'none';
          //  showToast('تم حفظ الفاتورة الحالية، يمكنك العودة إليها لاحقاً', 'info');
        }

        function addProductToInvoice(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // التحقق مما إذا كان المنتج موجود بالفعل في الفاتورة
            const existingItem = currentInvoice.items.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                currentInvoice.items.push({
                    id: product.id,
                    description: product.description,
                    price: product.salePrice,
                    quantity: 1
                });
            }
            
            saveCurrentInvoice();
            
            // إذا كان نموذج الفاتورة مفتوحًا، قم بتحديث العرض
            if (document.getElementById('invoiceModal').style.display === 'flex') {
                renderInvoiceItems();
                updateInvoiceSummary();
            }
            
            showToast('تم إضافة المنتج إلى الفاتورة');
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItemsContainer');
            container.innerHTML = '';
            
            if (currentInvoice.items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;">لا توجد منتجات في الفاتورة</p>';
                return;
            }
            
            currentInvoice.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'invoice-item';
                
                itemElement.innerHTML = `
                    <div class="invoice-item-details">
                        <div class="invoice-item-id">${item.id}</div>
                        <div class="invoice-item-description">${item.description}</div>
                    </div>
                    <div class="invoice-item-controls">
                        <div class="quantity-control">
                            <button class="decrease-quantity" data-id="${item.id}">-</button>
                            <input type="number" value="${item.quantity}" min="1" data-id="${item.id}">
                            <button class="increase-quantity" data-id="${item.id}">+</button>
                        </div>
                        <div class="invoice-item-price">${(item.price * item.quantity).toFixed(2)} $</div>
                        <button class="invoice-item-remove" data-id="${item.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(itemElement);
            });
            
            // إضافة الأحداث للتحكم في الكميات
            document.querySelectorAll('.decrease-quantity').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    updateInvoiceItemQuantity(productId, -1);
                });
            });
            
            document.querySelectorAll('.increase-quantity').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    updateInvoiceItemQuantity(productId, 1);
                });
            });
            
            document.querySelectorAll('.invoice-item-remove').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    removeInvoiceItem(productId);
                });
            });
            
            document.querySelectorAll('.quantity-control input').forEach(input => {
                input.addEventListener('change', function() {
                    const productId = this.getAttribute('data-id');
                    const newQuantity = parseInt(this.value) || 1;
                    setInvoiceItemQuantity(productId, newQuantity);
                });
            });
        }

        function updateInvoiceItemQuantity(productId, change) {
            const item = currentInvoice.items.find(item => item.id === productId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity < 1) {
                item.quantity = 1;
            }
            
            saveCurrentInvoice();
            renderInvoiceItems();
            updateInvoiceSummary();
        }

        function setInvoiceItemQuantity(productId, quantity) {
            const item = currentInvoice.items.find(item => item.id === productId);
            if (!item) return;
            
            item.quantity = quantity;
            
            if (item.quantity < 1) {
                item.quantity = 1;
            }
            
            saveCurrentInvoice();
            renderInvoiceItems();
            updateInvoiceSummary();
        }

        function removeInvoiceItem(productId) {
            currentInvoice.items = currentInvoice.items.filter(item => item.id !== productId);
            saveCurrentInvoice();
            renderInvoiceItems();
            updateInvoiceSummary();
            showToast('تم إزالة المنتج من الفاتورة');
        }

        function updateInvoiceSummary() {
            const itemsCount = currentInvoice.items.reduce((sum, item) => sum + item.quantity, 0);
            const subtotal = currentInvoice.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal;
            
            document.getElementById('invoiceItemsCount').textContent = itemsCount;
            document.getElementById('invoiceSubtotal').textContent = subtotal.toFixed(2) + ' $';
            document.getElementById('invoiceTotal').textContent = total.toFixed(2) + ' $';
            
            // حساب القيمة بالليرة السورية
            if (exchangeRate > 0) {
                const subtotalLira = (subtotal * exchangeRate).toFixed(0);
                document.getElementById('invoiceSubtotalLira').textContent = subtotalLira + ' ل.س';
            } else {
                document.getElementById('invoiceSubtotalLira').textContent = 'غير محدد';
            }
        }

        function saveInvoice() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            
            if (currentInvoice.items.length === 0) {
                showToast('لا يمكن حفظ فاتورة فارغة', 'error');
                return;
            }
            
            if (!customerName) {
                showToast('يرجى إدخال اسم العميل', 'error');
                return;
            }
            
            const invoice = {
                id: generateInvoiceId(),
                date: new Date().toISOString(),
                customerName,
                customerAddress,
                items: [...currentInvoice.items],
                subtotal: currentInvoice.items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                total: currentInvoice.items.reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };
            
            invoices.push(invoice);
            saveInvoices();
            
            // تحديث كميات المنتجات
            updateProductQuantitiesAfterInvoice(invoice);
            
            // إعادة تعيين الفاتورة الحالية بعد الحفظ
            currentInvoice = { items: [], customerName: '', customerAddress: '' };
            saveCurrentInvoice();
            
            showToast(`تم حفظ الفاتورة ${invoice.id} بنجاح`);
            closeInvoiceModal();
        }

        function generateInvoiceId() {
            const date = new Date();
            const year = date.getFullYear().toString().substr(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const count = invoices.filter(inv => {
                const invDate = new Date(inv.date);
                return invDate.getDate() === date.getDate() && 
                       invDate.getMonth() === date.getMonth() && 
                       invDate.getFullYear() === date.getFullYear();
            }).length + 1;
            
            return `INV-${year}${month}${day}-${count.toString().padStart(3, '0')}`;
        }

        function updateProductQuantitiesAfterInvoice(invoice) {
            invoice.items.forEach(invoiceItem => {
                const product = products.find(p => p.id === invoiceItem.id);
                if (product) {
                    product.quantity -= invoiceItem.quantity;
                    if (product.quantity < 0) product.quantity = 0;
                    
                    // تحديث تاريخ آخر تحديث
                    product.updatedAt = new Date().toISOString();
                    
                    // تسجيل الحركة
                    recordTransaction(product.id, 'بيع من فاتورة', invoiceItem.quantity);
                }
            });
            
            saveProducts();
            renderProducts(null, true);
            updateStats();
        }

        // ===================================
        // عرض الفواتير المحفوظة
        // ===================================
        
        function showInvoicesModal() {
            renderInvoicesList();
            document.getElementById('invoicesModal').style.display = 'flex';
        }

        function closeInvoicesModal() {
            document.getElementById('invoicesModal').style.display = 'none';
        }

        function renderInvoicesList() {
            const invoicesList = document.getElementById('invoicesList');
            invoicesList.innerHTML = '';
            
            if (invoices.length === 0) {
                invoicesList.innerHTML = '<p style="text-align: center; color: #777;">لا توجد فواتير محفوظة</p>';
                return;
            }
            
            // ترتيب الفواتير من الأحدث إلى الأقدم
            const sortedInvoices = [...invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedInvoices.forEach(invoice => {
                const invoiceElement = document.createElement('div');
                invoiceElement.className = 'invoice-item-detailed';
                
                // حساب القيمة بالليرة السورية
                const subtotalLira = exchangeRate > 0 ? (invoice.total * exchangeRate).toFixed(0) : 'غير محدد';
                
                invoiceElement.innerHTML = `
                    <div class="invoice-item-header">
                        <div class="invoice-item-id">${invoice.id}</div>
                        <div class="invoice-item-date">${formatDateTime(invoice.date)}</div>
                    </div>
                    <div class="invoice-item-customer">
                        <strong>العميل:</strong> ${invoice.customerName} ${invoice.customerAddress ? `- ${invoice.customerAddress}` : ''}
                    </div>
                    <div class="invoice-item-products">
                        ${invoice.items.map(item => `
                            <div class="invoice-product-item">
                                <span>${item.id} - ${item.description}</span>
                                <span>${item.quantity} × ${item.price.toFixed(2)} $ = ${(item.quantity * item.price).toFixed(2)} $</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="invoice-item-total">
                        المجموع: ${invoice.total.toFixed(2)} $ (${subtotalLira} ل.س)
                    </div>
                    <div class="invoice-actions">
                        <button class="invoice-print-btn" data-invoice-id="${invoice.id}">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                        <button class="invoice-delete-btn" data-invoice-id="${invoice.id}">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                `;
                
                invoicesList.appendChild(invoiceElement);
            });
            
            // إضافة الأحداث لأزرار الفواتير
            document.querySelectorAll('.invoice-print-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceId = this.getAttribute('data-invoice-id');
                    printInvoice(invoiceId);
                });
            });
            
            document.querySelectorAll('.invoice-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const invoiceId = this.getAttribute('data-invoice-id');
                    deleteInvoice(invoiceId);
                });
            });
        }

        function printInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;
            
            // إنشاء نافذة طباعة
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>فاتورة ${invoice.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .invoice-id { font-size: 24px; font-weight: bold; color: #3498db; }
                        .date { color: #777; margin-top: 5px; }
                        .customer { margin-bottom: 20px; }
                        .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        .items-table th, .items-table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                        .items-table th { background-color: #f2f2f2; }
                        .total { text-align: left; font-size: 18px; font-weight: bold; margin-top: 20px; }
                        .footer { margin-top: 30px; text-align: center; color: #777; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="invoice-id">فاتورة ${invoice.id}</div>
                        <div class="date">${formatDateTime(invoice.date)}</div>
                    </div>
                    
                    <div class="customer">
                        <strong>العميل:</strong> ${invoice.customerName}<br>
                        ${invoice.customerAddress ? `<strong>العنوان:</strong> ${invoice.customerAddress}` : ''}
                    </div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>المجموع</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.id} - ${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)} $</td>
                                    <td>${(item.quantity * item.price).toFixed(2)} $</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        <strong>المجموع الكلي:</strong> ${invoice.total.toFixed(2)} $
                        ${exchangeRate > 0 ? `<br><strong>المجموع بالليرة السورية:</strong> ${(invoice.total * exchangeRate).toFixed(0)} ل.س` : ''}
                    </div>
                    
                    <div class="footer">
                        شكراً لتعاملكم مع أبو الياس للكهرباء
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        function deleteInvoice(invoiceId) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                invoices = invoices.filter(inv => inv.id !== invoiceId);
                saveInvoices();
                renderInvoicesList();
                showToast('تم حذف الفاتورة بنجاح');
            }
        }

        // ===================================
        // نظام مسح الباركود - الإصلاح الكامل
        // ===================================
        
        function openBarcodeModal() {
            document.getElementById('barcodeScanModal').style.display = 'flex';
            document.getElementById('barcodeResult').innerHTML = '<p>سيظهر رمز الباركود هنا عند مسحه</p>';
            scannedBarcode = '';
            
            // إيقاف أي ماسح نشط سابقاً
            stopBarcodeScanner();
        }

        function closeBarcodeModal() {
            document.getElementById('barcodeScanModal').style.display = 'none';
            stopBarcodeScanner();
        }

        function startBarcodeScanner() {
            const scannerElement = document.getElementById('interactive');
            
            if (!scannerElement) {
                showToast('عنصر الماسح غير موجود', 'error');
                return;
            }
            
            // تنظيف العنصر أولاً
            scannerElement.innerHTML = '';
            
            // تهيئة Quagga مع تحسين الإعدادات
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerElement,
                    constraints: {
                        width: 400,
                        height: 300,
                        facingMode: "environment" // استخدام الكاميرا الخلفية
                    },
                    area: { // تحديد منطقة المسح لتحسين الأداء
                        top: "0%",
                        right: "0%",
                        left: "0%", 
                        bottom: "0%"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader", 
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ],
                    multiple: false
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                locate: true,
                numOfWorkers: navigator.hardwareConcurrency || 4
            }, function(err) {
                if (err) {
                    console.error('خطأ في تهيئة الماسح:', err);
                    showToast('خطأ في تشغيل الكاميرا: ' + (err.message || 'غير معروف'), 'error');
                    return;
                }
                
                console.log('تم تهيئة الماسح بنجاح');
                Quagga.start();
                currentScanner = Quagga;
                
                showToast('بدأ المسح، ركز على الباركود', 'info');
            });

            // معالجة النتائج المكتشفة
            Quagga.onDetected(function(result) {
                if (result.codeResult && result.codeResult.code) {
                    const code = result.codeResult.code;
                    console.log('تم اكتشاف الباركود:', code);
                    
                    scannedBarcode = code;
                    document.getElementById('barcodeResult').innerHTML = `
                        <p>تم مسح الباركود بنجاح:</p>
                        <h3>${scannedBarcode}</h3>
                        <p style="font-size: 12px; color: #27ae60;">
                            <i class="fas fa-check-circle"></i> جاهز للاستخدام
                        </p>
                    `;
                    
                    // إيقاف الماسح تلقائياً بعد الاكتشاف
                    stopBarcodeScanner();
                    showToast('تم مسح الباركود بنجاح!', 'success');
                }
            });

            // معالجة الأخطاء
            Quagga.onProcessed(function(result) {
                if (result && result.codeResult && !result.codeResult.code) {
                    console.log('جارٍ المسح...');
                }
            });
        }

        function stopBarcodeScanner() {
            if (currentScanner) {
                try {
                    currentScanner.offDetected();
                    currentScanner.offProcessed();
                    currentScanner.stop();
                    console.log('تم إيقاف الماسح');
                } catch (e) {
                    console.error('خطأ في إيقاف الماسح:', e);
                }
                currentScanner = null;
            }
            
            // تنظيف عنصر العرض
            const scannerElement = document.getElementById('interactive');
            if (scannerElement) {
                scannerElement.innerHTML = '';
            }
        }

        function useScannedBarcode() {
            if (scannedBarcode) {
                // البحث عن المنتج باستخدام الباركود
                const product = products.find(p => p.id === scannedBarcode);
                
                if (product) {
                    // إذا وجد المنتج، إضافته إلى الفاتورة
                    addProductToInvoice(product.id);
                    closeBarcodeModal();
                    showToast(`تم إضافة المنتج ${product.id} إلى الفاتورة`, 'success');
                } else {
                    // إذا لم يوجد المنتج، استخدام الباركود كمعرف منتج جديد
                    closeBarcodeModal();
                    document.getElementById('productId').value = scannedBarcode;
                    document.getElementById('productModal').style.display = 'flex';
                    showToast(`يمكنك الآن إضافة منتج جديد بالمعرف ${scannedBarcode}`, 'info');
                }
            } else {
                showToast('لم يتم مسح أي باركود', 'error');
            }
        }

        // ===================================
        // وظائف الفرز والفلترة
        // ===================================
        
        function getLowAttentionProducts(list = products) {
            return list.filter(product => {
                const profit = product.salePrice - product.purchasePrice;
                // شرط التنبيه: مخزون قليل جداً (<= reorderPoint) أو ربح قليل (< 2)
                return product.quantity <= product.reorderPoint
            });
        }
        
        function applySort(list) {
            const sortValue = sortSelector.value;
            const [field, direction] = sortValue.split('_');
            
            const dir = direction === 'asc' ? 1 : -1;
            
            return list.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'profit') {
                    aVal = a.salePrice - a.purchasePrice;
                    bVal = b.salePrice - b.purchasePrice;
                }
                
                if (aVal < bVal) return -1 * dir;
                if (aVal > bVal) return 1 * dir;
                return 0;
            });
        }

        function updateCategoryFilter() {
            const categories = new Set(products.map(p => p.category).filter(c => c));
            categoryFilter.innerHTML = '<option value="all">جميع الفئات</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            handleFilterSortChange();
        }

        function handleFilterSortChange() {
            let filteredList = [...products];

            // 1. فلترة الانتباه
            if (isAttentionFiltered) {
                filteredList = getLowAttentionProducts(filteredList);
            }

            // 2. فلترة الفئة
            const selectedCategory = categoryFilter.value;
            if (selectedCategory !== 'all') {
                filteredList = filteredList.filter(p => p.category === selectedCategory);
            }
            
            // 3. الفرز
            filteredList = applySort(filteredList);

            // 4. إظهار النتائج مع التقسيم للصفحات
            currentPage = 1;
            renderProducts(filteredList, false); 
        }
        
        function toggleAttentionFilter() {
            isAttentionFiltered = !isAttentionFiltered;
            attentionFilterBtn.classList.toggle('active', isAttentionFiltered);
            attentionFilterBtn.querySelector('span').textContent = isAttentionFiltered ? 'عرض الكل' : 'عرض الانتباه';
            
            if (!isAttentionFiltered && categoryFilter.value === 'all' && !searchInput.value.trim()) {
                renderProducts(null, true);
            } else {
                handleFilterSortChange();
            }
        }

        // ===================================
        // وظائف عرض المنتجات
        // ===================================
        
        function renderProductCard(product) {
            const profit = product.salePrice - product.purchasePrice;
            const profitText = profit >= 0 ? `+${profit.toFixed(2)}` : product.salePrice.toFixed(2);
            const stockStatus = product.quantity <= product.reorderPoint ? (product.quantity <= 0 ? 'very-low-stock-alert' : 'low-stock-alert') : '';
            const quantityTextColor = product.quantity <= product.reorderPoint ? (product.quantity <= 0 ? 'very-low-stock-text' : 'low-stock-text') : 'quantity-value';
            
            let liraPrices = '';
            if (exchangeRate > 0) {
                const purchasePriceLira = (product.purchasePrice * exchangeRate).toFixed(0);
                const salePriceLira = (product.salePrice * exchangeRate).toFixed(0);
                const profitLira = (profit * exchangeRate).toFixed(0);
                liraPrices = `
                    <div class="currency-note">
                        ${purchasePriceLira} ل.س | ${salePriceLira} ل.س | ${profit >= 0 ? '+' : ''}${profitLira} ل.س
                    </div>
                `;
            }
            
            const reorderDisplay = product.quantity <= product.reorderPoint && product.quantity > 0 
                ? `<div class="reorder-point-display">تحتاج لإعادة طلب (الحد: ${product.reorderPoint})</div>` 
                : '';

            return `
                <div class="product-card ${stockStatus}">
                    <div class="product-header">
                        <div class="product-category">${product.category || 'غير مصنف'}</div>
                        <div class="product-id">${product.id}</div>
                    </div>
                    <div class="product-body">
                        <div class="product-quantity">
                            <span class="quantity-label">الكمية المتاحة:</span>
                            <span class="${quantityTextColor}">${product.quantity}</span>
                        </div>
                        ${reorderDisplay}
                        <div class="product-description">${product.description}</div>
                        <div class="product-prices">
                            <div class="price-item">
                                <div class="price-label">سعر الشراء</div>
                                <div class="price-value purchase-price">${product.purchasePrice.toFixed(2)} $</div>
                            </div>
                            <div class="price-item">
                                <div class="price-label">سعر المبيع</div>
                                <div class="price-value sale-price">${product.salePrice.toFixed(2)} $</div>
                            </div>
                        </div>
                        <div class="product-profit">
                            الربح للقطعة: ${profit.toFixed(2)} $
                        </div>
                        ${liraPrices}
                        <div class="product-dates">
                            <span> <i class="fas fa-plus-square"></i> تاريخ الإنشاء: ${formatDateTime(product.createdAt)} </span>
                            <span> <i class="fas fa-sync-alt"></i> آخر تحديث: ${formatDateTime(product.updatedAt)} </span>
                        </div>
                    </div>
                    <div class="product-actions" style="padding: 15px; border-top: 1px solid var(--light-border);">
                            <button class="add-to-invoice-btn" onclick="addProductToInvoice('${product.id}', event)">
                                <i class="fas fa-file-invoice"></i> فاتورة
                            </button>
                            <button class="sell-btn" onclick="openSellModal('${product.id}', event)">
                                <i class="fas fa-hand-holding-usd"></i> بيع
                            </button>
                            <button class="add-quantity-btn" onclick="openAddQuantityModal('${product.id}', event)">
                                <i class="fas fa-plus-circle"></i> 
                            </button>
                            <button class="edit-btn" onclick="editProduct('${product.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="deleteProduct('${product.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                    </div>
                </div>
            `;
        }

        function renderProducts(filteredProducts = null, reset = false) {
            const productsList = filteredProducts || products;
            
            if (reset) {
                currentPage = 1;
                isSearching = false;
            }

            if (filteredProducts !== null || searchInput.value.trim() || categoryFilter.value !== 'all' || isAttentionFiltered) {
                isSearching = (filteredProducts !== null);
                productsGrid.innerHTML = productsList.map(renderProductCard).join('');
                showMoreBtn.style.display = 'none';
                loadingIndicator.style.display = 'none';
                return;
            }

            isSearching = false;
            let productsToDisplay;
            
            const startIndex = 0;
            const endIndex = currentPage * productsPerPage;
            
            if (productsList.length > endIndex) {
                productsToDisplay = productsList.slice(startIndex, endIndex);
                showMoreBtn.style.display = 'flex';
                showMoreBtn.querySelector('span').textContent = `عرض المزيد (${productsList.length - endIndex} منتج متبقي)`;
            } else {
                productsToDisplay = productsList;
                showMoreBtn.style.display = 'none';
            }

            productsGrid.innerHTML = productsToDisplay.map(renderProductCard).join('');
            loadingIndicator.style.display = 'none';

            if (productsList.length === 0) {
                 productsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>لا توجد منتجات</h3>
                        <p>انقر على "إضافة منتج جديد" لبدء إدارة المخزون</p>
                    </div>
                `;
            }
        }
        
        function showMoreProducts() {
            if (isSearching) return;
            
            currentPage++;
            loadingIndicator.style.display = 'block';
            showMoreBtn.disabled = true;

            setTimeout(() => {
                renderProducts(null, false);
                showMoreBtn.disabled = false;
            }, 100); 
        }

        // ===================================
        // وظائف CRUD وحركة المخزون
        // ===================================

        function openAddModal() {
            isEditMode = false;
            modalTitle.textContent = 'إضافة منتج جديد';
            productForm.reset();
            productIdInput.disabled = false;
            productQuantityInput.disabled = false;
            reorderPointInput.value = 5; // قيمة افتراضية
            productModal.style.display = 'flex';
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return showToast('لم يتم العثور على المنتج!', 'error');
            
            isEditMode = true;
            currentEditId = id;
            modalTitle.textContent = `تعديل المنتج: ${id}`;
            
            productIdInput.value = product.id;
            productDescriptionInput.value = product.description;
            productCategoryInput.value = product.category || 'اخرى';
            purchasePriceInput.value = product.purchasePrice;
            salePriceInput.value = product.salePrice;
            productQuantityInput.value = product.quantity;
            reorderPointInput.value = product.reorderPoint || 5; 
            
            productIdInput.disabled = true;
            productQuantityInput.disabled = false;
            
            productModal.style.display = 'flex';
        }

        function closeProductModalFunc() {
            productModal.style.display = 'none';
        }

        function handleProductFormSubmit(e) {
            e.preventDefault();
            
            const id = productIdInput.value.trim();
            const description = productDescriptionInput.value;
            const category = productCategoryInput.value;
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const salePrice = parseFloat(salePriceInput.value);
            const quantity = parseInt(productQuantityInput.value, 10);
            const reorderPoint = parseInt(reorderPointInput.value, 10);
            const now = new Date().toISOString();
            
            if (isNaN(reorderPoint) || reorderPoint < 1) {
                return showToast('يجب أن تكون نقطة إعادة الطلب رقماً صحيحاً وموجباً (1 أو أكثر).', 'error');
            }

            if (isEditMode) {
                const index = products.findIndex(p => p.id === currentEditId);
                if (index !== -1) {
                    const oldQuantity = products[index].quantity;
                    products[index] = { 
                        ...products[index],
                        description, 
                        category,
                        purchasePrice, 
                        salePrice, 
                        quantity,
                        reorderPoint,
                        updatedAt: now
                    };
                    if (oldQuantity !== quantity) {
                        const change = quantity - oldQuantity;
                        const type = change > 0 ? 'تعديل - إضافة' : 'تعديل - خصم';
                        recordTransaction(currentEditId, type, Math.abs(change));
                    }
                    showToast('تم تعديل المنتج بنجاح!', 'success');
                }
            } else {
                if (products.some(p => p.id === id)) {
                    showToast('معرف المنتج موجود مسبقاً. الرجاء استخدام معرف مختلف.', 'error');
                    return;
                }
                
                products.unshift({ 
                    id, description, purchasePrice, salePrice, quantity,
                    category,
                    reorderPoint,
                    createdAt: now, 
                    updatedAt: now
                });
                showToast('تم إضافة المنتج بنجاح!', 'success');
            }
            
            saveProducts();
            updateCategoryFilter();
            renderProducts(null, true);
            closeProductModalFunc();
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟ سيتم حذف جميع سجلات حركته أيضاً.')) {
                products = products.filter(p => p.id !== id);
                transactions = transactions.filter(t => t.productId !== id);
                saveProducts();
                saveTransactions();
                updateCategoryFilter();
                renderProducts(null, true);
                showToast('تم حذف المنتج بنجاح.', 'warning');
            }
        }
        
        function handleAddQuantitySubmit(e) {
            e.preventDefault();
            
            const quantityToAdd = parseInt(document.getElementById('quantityToAdd').value, 10);
            const now = new Date().toISOString();
            
            if (currentQuantityProductId && quantityToAdd > 0) {
                const index = products.findIndex(p => p.id === currentQuantityProductId);
                if (index !== -1) {
                    products[index].quantity += quantityToAdd;
                    products[index].updatedAt = now;
                    
                    recordTransaction(currentQuantityProductId, 'إضافة', quantityToAdd);
                    
                    saveProducts();
                    renderProducts(null, true);
                    document.getElementById('addQuantityModal').style.display = 'none';
                    showToast(`تم إضافة ${quantityToAdd} قطعة إلى ${currentQuantityProductId}.`, 'success');
                }
            }
        }

        function handleSellSubmit(e) {
            e.preventDefault();

            const quantityToSell = parseInt(document.getElementById('quantityToSell').value, 10);
            const now = new Date().toISOString();
            
            if (currentSellProductId && quantityToSell > 0) {
                const index = products.findIndex(p => p.id === currentSellProductId);
                
                if (index !== -1) {
                    const product = products[index];
                    
                    if (quantityToSell > product.quantity) {
                        showToast(`الكمية المباعة (${quantityToSell}) أكبر من الكمية المتاحة (${product.quantity}).`, 'error');
                        return;
                    }

                    products[index].quantity -= quantityToSell;
                    products[index].updatedAt = now;
                    
                    recordTransaction(currentSellProductId, 'بيع', quantityToSell);
                    
                    saveProducts();
                    renderProducts(null, true);
                    document.getElementById('sellModal').style.display = 'none';
                    showToast(`تم بيع وخصم ${quantityToSell} قطعة من ${currentSellProductId}.`, 'success');
                }
            }
        }

        // ===================================
        // وظائف الإحصائيات وسجل التحركات
        // ===================================
        
        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            
            const totalProfitValue = products.reduce((sum, product) => {
                const profit = product.salePrice - product.purchasePrice;
                return sum + (profit * product.quantity);
            }, 0);
            document.getElementById('totalProfit').textContent = `${totalProfitValue.toFixed(2)} $`;
            
            if (exchangeRate > 0) {
                document.getElementById('totalProfitLira').textContent = `${(totalProfitValue * exchangeRate).toFixed(0)} ل.س`;
            } else {
                document.getElementById('totalProfitLira').textContent = `غير محدد`;
            }
            
            document.getElementById('totalTransactions').textContent = transactions.length;
            
            const lowAttentionProducts = getLowAttentionProducts();
            document.getElementById('lowStockCount').textContent = lowAttentionProducts.length;
            
            document.getElementById('lowStockUl').innerHTML = lowAttentionProducts.map(product => {
                const profit = product.salePrice - product.purchasePrice;
                let reason = [];
                if (product.quantity <= product.reorderPoint) {
                    reason.push(`مخزون قليل: ${product.quantity} (الحد: ${product.reorderPoint})`);
                }
                if (profit < LOW_PROFIT_THRESHOLD) {
                    reason.push(`ربح قليل: ${profit.toFixed(2)} $`);
                }
                return `
                    <li>
                        <span>${product.id}</span>
                        <span style="font-size: 0.9em; color: #777;">(${reason.join(' | ')})</span>
                    </li>
                `;
            }).join('');
            
            if (lowAttentionProducts.length === 0) {
                document.getElementById('lowStockUl').innerHTML = '<li><i class="fas fa-check-circle" style="color: var(--success-color); margin-left: 5px;"></i> لا توجد منتجات تحتاج انتباهاً حالياً.</li>';
            }
        }
        
        function openTransactionsModal() {
            transactionsTableBody.innerHTML = '';
            
            transactions.forEach(t => {
                const row = transactionsTableBody.insertRow();
                row.style.backgroundColor = t.type.includes('بيع') ? 'rgba(231, 76, 60, 0.05)' : 'rgba(39, 174, 96, 0.05)';
                row.innerHTML = `
                    <td style="padding: 10px; border-bottom: 1px dotted var(--light-border);">${t.productId}</td>
                    <td style="padding: 10px; border-bottom: 1px dotted var(--light-border);">${t.type}</td>
                    <td style="padding: 10px; border-bottom: 1px dotted var(--light-border); color: ${t.type.includes('بيع') ? 'var(--danger-color)' : 'var(--success-color)'}; font-weight: 600;">${t.type.includes('بيع') ? '-' : '+'}${t.quantityChange}</td>
                    <td style="padding: 10px; border-bottom: 1px dotted var(--light-border);">${formatDateTime(t.timestamp)}</td>
                `;
            });
            
            if (transactions.length === 0) {
                transactionsTableBody.innerHTML = '<tr><td colspan="4" style="padding: 20px; color: #999;">لا توجد حركات مسجلة حالياً.</td></tr>';
            }
            
            transactionsModal.style.display = 'flex';
        }
        
        function clearTransactions() {
            if (confirm('هل أنت متأكد من حذف سجل التحركات بالكامل؟')) {
                transactions = [];
                saveTransactions();
                openTransactionsModal(); 
                updateStats();
                showToast('تم حذف سجل التحركات بنجاح.', 'success');
            }
        }

        // ===================================
        // وظائف إضافية
        // ===================================
        
        function openSellModal(id, event) {
            event.stopPropagation();
            const product = products.find(p => p.id === id);
            if (!product) return;

            currentSellProductId = id;
            document.getElementById('sellModalTitle').textContent = `بيع قطع من: ${product.id}`;
            document.getElementById('currentStockDisplay').textContent = product.quantity;
            document.getElementById('quantityToSell').max = product.quantity;
            document.getElementById('sellForm').reset();
            document.getElementById('sellModal').style.display = 'flex';
        }

        function openAddQuantityModal(id, event) {
            event.stopPropagation();
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            currentQuantityProductId = id;
            document.getElementById('addQuantityTitle').textContent = `إضافة كمية إلى: ${product.id}`;
            document.getElementById('addQuantityForm').reset();
            document.getElementById('addQuantityModal').style.display = 'flex';
        }

        function handleSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (!searchTerm) {
                if (categoryFilter.value !== 'all' || isAttentionFiltered || sortSelector.value !== 'updatedAt_desc') {
                    handleFilterSortChange();
                } else {
                    renderProducts(null, true); 
                }
                return;
            }
            
            const filteredProducts = products.filter(product => {
                const id = product.id.toLowerCase();
                const description = product.description.toLowerCase();
                return id.includes(searchTerm) || description.includes(searchTerm);
            });
            
            renderProducts(filteredProducts);
        }
        
        function openStatsModal() {
            updateStats();
            document.getElementById('lowStockList').style.display = 'none';
            document.getElementById('statsModal').style.display = 'flex';
        }
        
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function updateExchangeRate() {
            exchangeRate = parseFloat(document.getElementById('exchangeRateInput').value) || 0;
            localStorage.setItem('exchangeRate', exchangeRate);
            updateExchangeRateDisplay();
            renderProducts(null, true);
            showToast('تم تحديث سعر الصرف بنجاح.', 'success');
        }

        function updateExchangeRateDisplay() {
            if (exchangeRate > 0) {
                document.getElementById('currentExchangeRate').textContent = `1 دولار = ${exchangeRate} ليرة سورية`;
            } else {
                document.getElementById('currentExchangeRate').textContent = 'غير محدد';
            }
            document.getElementById('exchangeRateInput').value = exchangeRate || '';
        }
        
        function exportData() {
            const dataToExport = {
                products: products,
                transactions: transactions,
                invoices: invoices,
                categories: categories,
                exchangeRate: exchangeRate,
                darkMode: darkMode
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `inventory_export_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            showToast('تم تصدير البيانات بنجاح!', 'success');
        }

        function triggerImport() {
            document.getElementById('importFile').click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.products && Array.isArray(importedData.products)) {
                        products = importedData.products;
                        saveProducts();
                        
                        if (importedData.transactions && Array.isArray(importedData.transactions)) {
                            transactions = importedData.transactions;
                            saveTransactions();
                        }
                        if (importedData.invoices && Array.isArray(importedData.invoices)) {
                            invoices = importedData.invoices;
                            saveInvoices();
                        }
                        if (importedData.categories && Array.isArray(importedData.categories)) {
                            categories = importedData.categories;
                            saveCategories();
                        }
                        if (importedData.exchangeRate) {
                            exchangeRate = parseFloat(importedData.exchangeRate);
                            localStorage.setItem('exchangeRate', exchangeRate);
                        }
                        if (importedData.darkMode !== undefined) {
                            darkMode = importedData.darkMode;
                            localStorage.setItem('darkMode', darkMode);
                        }

                        initApp(); 
                        showToast('تم استيراد البيانات بنجاح!', 'success');
                    } else {
                        showToast('ملف غير صالح. يرجى التأكد من أن الملف بصيغة JSON ويحتوي على بيانات المنتجات.', 'error');
                    }
                } catch (error) {
                    showToast('خطأ في قراءة الملف أو تنسيقه. يرجاء التأكد من صيغة الملف.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function deleteAllData() {
            if (confirm('هل أنت متأكد من حذف جميع بيانات المخزون (المنتجات وسجل المبيعات والفواتير)؟ لا يمكن التراجع عن هذا الإجراء.')) {
                products = [];
                transactions = [];
                invoices = [];
                categories = ['كابلات', 'قواطع', 'مقابس', 'إضاءة', 'لوحات', 'اخرى'];
                localStorage.removeItem('products');
                localStorage.removeItem('transactions');
                localStorage.removeItem('invoices');
                localStorage.removeItem('categories');
                renderProducts(null, true);
                updateStats();
                showToast('تم حذف جميع البيانات.', 'danger');
            }
        }

        // ===================================
        // وظائف التهيئة والمستمعين
        // ===================================

        function initApp() {
            products = products.map(p => ({
                ...p,
                createdAt: p.createdAt || new Date().toISOString(),
                updatedAt: p.updatedAt || new Date().toISOString(),
                category: p.category || 'اخرى',
                reorderPoint: p.reorderPoint || 5,
            }));
            saveProducts();
            
            updateTheme();
            updateCategoriesDropdown();
            updateCategoryFilter();
            renderProducts(null, true);
            updateExchangeRateDisplay();
            
            // إضافة المستمعين
            document.getElementById('lowStockCard').addEventListener('click', () => {
                document.getElementById('lowStockList').style.display = document.getElementById('lowStockList').style.display === 'block' ? 'none' : 'block';
            });
            
            document.getElementById('exchangeRateInput').addEventListener('change', updateExchangeRate);
            
            searchInput.addEventListener('input', handleSearch);
            sortSelector.addEventListener('change', handleFilterSortChange);
            categoryFilter.addEventListener('change', handleFilterSortChange);
            attentionFilterBtn.addEventListener('click', toggleAttentionFilter);
            
            document.getElementById('viewTransactionsBtn').addEventListener('click', openTransactionsModal);
            document.getElementById('viewInvoicesBtn').addEventListener('click', showInvoicesModal);
            document.getElementById('closeTransactionsModal').addEventListener('click', () => transactionsModal.style.display = 'none');
            document.getElementById('closeInvoicesModal').addEventListener('click', closeInvoicesModal);
            clearTransactionsBtn.addEventListener('click', clearTransactions);

            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('statsBtn').addEventListener('click', openStatsModal);
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
            document.getElementById('categoriesBtn').addEventListener('click', showCategoriesModal);
            document.getElementById('invoiceBtn').addEventListener('click', showInvoiceModal);
            document.getElementById('createInvoiceBtn').addEventListener('click', showInvoiceModal);
            document.getElementById('addProductBtn').addEventListener('click', openAddModal);
            document.getElementById('closeModal').addEventListener('click', closeProductModalFunc);
            document.getElementById('cancelBtn').addEventListener('click', closeProductModalFunc);
            document.getElementById('productForm').addEventListener('submit', handleProductFormSubmit);
            document.getElementById('showMoreBtn').addEventListener('click', showMoreProducts);
            document.getElementById('addQuantityForm').addEventListener('submit', handleAddQuantitySubmit);
            document.getElementById('sellForm').addEventListener('submit', handleSellSubmit);
            document.getElementById('scanBarcodeBtn').addEventListener('click', openBarcodeModal);
            document.getElementById('closeBarcodeModal').addEventListener('click', closeBarcodeModal);
            document.getElementById('closeBarcodeBtn').addEventListener('click', closeBarcodeModal);
            document.getElementById('startScanner').addEventListener('click', startBarcodeScanner);
            document.getElementById('stopScanner').addEventListener('click', stopBarcodeScanner);
            document.getElementById('useBarcodeBtn').addEventListener('click', useScannedBarcode);
            document.getElementById('closeAddQuantityModal').addEventListener('click', () => document.getElementById('addQuantityModal').style.display = 'none');
            document.getElementById('cancelAddQuantityBtn').addEventListener('click', () => document.getElementById('addQuantityModal').style.display = 'none');
            document.getElementById('closeSellModal').addEventListener('click', () => document.getElementById('sellModal').style.display = 'none');
            document.getElementById('cancelSellBtn').addEventListener('click', () => document.getElementById('sellModal').style.display = 'none');
            document.getElementById('closeStatsModal').addEventListener('click', () => document.getElementById('statsModal').style.display = 'none');
            document.getElementById('closeSettingsModal').addEventListener('click', () => document.getElementById('settingsModal').style.display = 'none');
            document.getElementById('closeCategoriesModal').addEventListener('click', closeCategoriesModal);
            document.getElementById('cancelCategoryForm').addEventListener('click', closeCategoriesModal);
            document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
            document.getElementById('closeInvoiceModal').addEventListener('click', closeInvoiceModal);
            document.getElementById('cancelInvoice').addEventListener('click', closeInvoiceModal);
            document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', triggerImport);
            document.getElementById('importFile').addEventListener('change', importData);
            document.getElementById('deleteDataBtn').addEventListener('click', deleteAllData);
        }

        document.addEventListener('DOMContentLoaded', initApp);
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js');
  });
}

    </script>
</body>
</html>